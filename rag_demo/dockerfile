# PyTorch + CUDA 12.8 + cuDNN9 (이미 torch/torchvision 설치됨)
FROM pytorch/pytorch:2.8.0-cuda12.8-cudnn9-devel

ENV PYTHONUNBUFFERED=1 \
    TZ=Asia/Seoul \
    PIP_NO_CACHE_DIR=1 \
    HF_HOME=/root/.cache/huggingface

WORKDIR /app

# 1) 의존성 먼저 복사 → 캐시 최대 활용
COPY requirements.txt .

# 2) 파이썬 패키지 설치 (torch는 requirements.txt에 넣지 말 것)
RUN pip install --upgrade pip setuptools wheel && \
    pip install --no-cache-dir -r requirements.txt

# 3) 애플리케이션 소스
COPY app ./app

EXPOSE 9000

# compose에서 command 지정 안 하면 아래가 기본으로 실행됨
CMD ["uvicorn", "app.app.main:app", "--host", "0.0.0.0", "--port", "9000", "--workers", "1"]
